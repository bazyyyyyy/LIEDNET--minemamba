# LIEDNet 完整安装步骤（新电脑）

## 前提条件
- 已安装 Anaconda 或 Miniconda
- 已安装 NVIDIA 驱动（CUDA 12.2）
- GPU: NVIDIA GeForce RTX 4090

---

## 完整安装命令（按顺序执行）

### 步骤 1: 创建 conda 环境

```bash
# 创建 Python 3.10 环境
conda create -n liednet python=3.10.19 -y

# 激活环境
conda activate liednet
```

### 步骤 2: 安装 PyTorch（CUDA 12.1，兼容 CUDA 12.2）

```bash
# 安装 PyTorch 和 torchvision（使用 CUDA 12.1，兼容您的 CUDA 12.2）
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121
```

**如果上面失败，尝试：**
```bash
# 方案 2: CUDA 12.4
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124

# 或方案 3: 最新稳定版
pip install torch torchvision
```

### 步骤 3: 安装基础依赖

```bash
# 进入项目目录
cd ~/下载/LIEDNet  # 或您的项目路径

# 安装 requirements.txt 中的依赖
pip install -r requirements.txt
```

### 步骤 4: 安装额外依赖

```bash
# 安装项目需要的额外包
pip install einops fvcore ptflops tensorboardx timm
```

### 步骤 5: 编译 selective_scan CUDA 扩展（重要！）

```bash
# 进入 selective_scan 目录
cd kernels/selective_scan

# 编译并安装
pip install -e .

# 返回项目根目录
cd ../..
```

### 步骤 6: 验证安装

```bash
# 验证 PyTorch
python -c "import torch; print('PyTorch:', torch.__version__); print('CUDA available:', torch.cuda.is_available()); print('CUDA version:', torch.version.cuda if torch.cuda.is_available() else 'N/A'); print('GPU:', torch.cuda.get_device_name(0) if torch.cuda.is_available() else 'N/A')"

# 验证关键依赖
python -c "import einops, fvcore, ptflops, tensorboardx, timm; print('所有依赖安装成功！')"

# 验证 selective_scan
python -c "try:
    import selective_scan_cuda_core
    print('✓ selective_scan CUDA 扩展: 安装成功')
except:
    print('⚠ selective_scan CUDA 扩展: 未找到（将使用 fallback，速度较慢）')"
```

### 步骤 7: 修改配置文件

```bash
# 编辑训练配置文件，修改数据集路径
nano options/train_LOLv1.yaml
# 或
vim options/train_LOLv1.yaml
```

修改以下路径：
```yaml
TRAINING:
  TRAIN_DIR: '/path/to/your/LOLv1/Train'  # 修改为您的训练数据路径
  VAL_DIR: '/path/to/your/LOLv1/Test'      # 修改为您的验证数据路径
```

### 步骤 8: 测试训练（可选）

```bash
# 运行训练脚本测试
python train_llie.py --opt ./options/train_LOLv1.yaml
```

---

## 一键安装脚本（所有步骤合并）

将以下内容保存为 `install_liednet.sh`，然后运行 `bash install_liednet.sh`：

```bash
#!/bin/bash

echo "=========================================="
echo "LIEDNet 环境安装"
echo "=========================================="

# 步骤 1: 创建环境
echo "步骤 1: 创建 conda 环境..."
conda create -n liednet python=3.10.19 -y
source $(conda info --base)/etc/profile.d/conda.sh
conda activate liednet

# 步骤 2: 安装 PyTorch
echo "步骤 2: 安装 PyTorch..."
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121 || \
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124 || \
pip install torch torchvision

# 步骤 3: 安装基础依赖
echo "步骤 3: 安装基础依赖..."
cd ~/下载/LIEDNet  # 修改为您的项目路径
pip install -r requirements.txt

# 步骤 4: 安装额外依赖
echo "步骤 4: 安装额外依赖..."
pip install einops fvcore ptflops tensorboardx timm

# 步骤 5: 编译 selective_scan
echo "步骤 5: 编译 selective_scan CUDA 扩展..."
cd kernels/selective_scan
pip install -e .
cd ../..

# 步骤 6: 验证
echo "步骤 6: 验证安装..."
python -c "import torch; print('PyTorch:', torch.__version__); print('CUDA:', torch.cuda.is_available())"
python -c "import einops, fvcore; print('依赖: OK')"

echo "=========================================="
echo "安装完成！"
echo "请运行: conda activate liednet"
echo "然后修改 options/train_LOLv1.yaml 中的数据集路径"
echo "=========================================="
```

---

## 常见问题解决

### Q1: PyTorch 安装失败
```bash
# 清除 pip 缓存
pip cache purge

# 使用国内镜像（如果网络慢）
pip install torch torchvision -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### Q2: selective_scan 编译失败
```bash
# 检查 CUDA 版本
nvcc --version

# 确保安装了编译工具
sudo apt-get install build-essential

# 如果仍然失败，代码中有 fallback，可以继续使用（但速度较慢）
```

### Q3: 导入错误
```bash
# 确保在正确的环境中
conda activate liednet

# 重新安装缺失的包
pip install <package_name>
```

---

## 快速参考命令

```bash
# 激活环境
conda activate liednet

# 检查环境
python -c "import torch; print(torch.__version__, torch.cuda.is_available())"

# 运行训练
python train_llie.py --opt ./options/train_LOLv1.yaml
```







