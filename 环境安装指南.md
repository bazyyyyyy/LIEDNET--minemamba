# LIEDNet 环境安装指南

## 在新电脑上重建 liednet 环境

### 步骤 1: 安装 Anaconda/Miniconda

如果新电脑还没有安装 conda，请先安装：

```bash
# 下载并安装 Miniconda (推荐，体积小)
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh

# 或者安装 Anaconda (完整版)
wget https://repo.anaconda.com/archive/Anaconda3-2024.10-1-Linux-x86_64.sh
bash Anaconda3-2024.10-1-Linux-x86_64.sh
```

安装完成后，重新打开终端或运行：
```bash
source ~/.bashrc
```

---

### 步骤 2: 创建 conda 环境

将 `environment.yml` 文件复制到新电脑，然后运行：

```bash
# 创建环境（会自动安装所有依赖）
conda env create -f environment.yml

# 激活环境
conda activate liednet
```

**注意**：如果 `environment.yml` 中的 conda channels 在新电脑上无法访问，可以：

1. **方法 A：使用默认 channels（推荐）**
   ```bash
   # 先创建基础环境
   conda create -n liednet python=3.10.19 -y
   conda activate liednet
   
   # 然后安装 pip 依赖
   pip install -r requirements.txt
   ```

2. **方法 B：修改 environment.yml**
   删除或注释掉 channels 部分，使用默认 conda channels

---

### 步骤 3: 安装 PyTorch（如果环境创建失败）

如果 conda 环境创建失败，可以手动安装：

```bash
conda activate liednet

# 根据您的 CUDA 版本安装 PyTorch
# CUDA 11.8
pip install torch==2.9.0 torchvision==0.24.0 --index-url https://download.pytorch.org/whl/cu118

# CUDA 12.1
pip install torch==2.9.0 torchvision==0.24.0 --index-url https://download.pytorch.org/whl/cu121

# CPU only (不推荐，训练会很慢)
pip install torch==2.9.0 torchvision==0.24.0
```

---

### 步骤 4: 安装其他依赖

```bash
conda activate liednet

# 安装基础依赖
pip install -r requirements.txt

# 安装额外依赖（如果 requirements.txt 中没有）
pip install einops fvcore ptflops tensorboardx timm
```

---

### 步骤 5: 编译 selective_scan CUDA 扩展（重要！）

这是最关键的步骤，必须编译 CUDA 扩展：

```bash
conda activate liednet
cd /path/to/LIEDNet/kernels/selective_scan

# 编译并安装
pip install -e .

# 验证安装
python -c "import selective_scan_cuda_core; print('Success!')"
```

如果编译失败，检查：
1. **CUDA 版本**：确保 CUDA 版本与 PyTorch 兼容
   ```bash
   nvcc --version  # 查看 CUDA 版本
   python -c "import torch; print(torch.version.cuda)"  # 查看 PyTorch 的 CUDA 版本
   ```

2. **编译工具**：确保安装了编译工具
   ```bash
   # Ubuntu/Debian
   sudo apt-get install build-essential
   
   # 确保有 CUDA toolkit
   which nvcc
   ```

3. **如果仍然失败**：可以尝试使用预编译版本或跳过（代码中有 fallback）

---

### 步骤 6: 验证环境

```bash
conda activate liednet

# 检查 Python 版本
python --version  # 应该是 Python 3.10.x

# 检查 PyTorch
python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}')"

# 检查关键依赖
python -c "import einops, fvcore, ptflops, tensorboardx; print('All dependencies OK!')"

# 检查 selective_scan
python -c "try:
    import selective_scan_cuda_core
    print('selective_scan CUDA extension: OK')
except:
    print('selective_scan CUDA extension: Not found (will use fallback)')"
```

---

### 步骤 7: 测试训练脚本

```bash
conda activate liednet
cd /path/to/LIEDNet

# 检查配置文件路径
# 编辑 options/train_LOLv1.yaml，确保数据集路径正确

# 运行训练（测试）
python train_llie.py --opt ./options/train_LOLv1.yaml
```

---

## 常见问题

### Q1: conda env create 失败，提示 channels 无法访问
**A**: 删除 `environment.yml` 中的 channels 部分，或使用国内镜像：
```bash
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free
```

### Q2: selective_scan 编译失败
**A**: 
1. 检查 CUDA 版本兼容性
2. 确保安装了 CUDA toolkit
3. 如果仍然失败，代码中有 PyTorch fallback，可以继续使用（但速度较慢）

### Q3: 导入错误 `ModuleNotFoundError`
**A**: 
```bash
conda activate liednet
pip install <missing_package>
```

### Q4: CUDA out of memory
**A**: 
- 检查 `options/train_LOLv1.yaml` 中的 `BATCH` 大小
- 确保已启用混合精度训练（代码中已包含）
- 如果 GPU 内存较小，将 `BATCH` 改为 2 或 4

---

## 快速安装脚本（一键安装）

创建 `setup_new_machine.sh`：

```bash
#!/bin/bash

# 1. 创建环境
conda create -n liednet python=3.10.19 -y
conda activate liednet

# 2. 安装 PyTorch (根据 CUDA 版本选择)
pip install torch==2.9.0 torchvision==0.24.0 --index-url https://download.pytorch.org/whl/cu118

# 3. 安装依赖
pip install -r requirements.txt
pip install einops fvcore ptflops tensorboardx timm

# 4. 编译 selective_scan
cd kernels/selective_scan
pip install -e .
cd ../..

# 5. 验证
python -c "import torch; print('PyTorch:', torch.__version__)"
python -c "import einops; print('einops: OK')"

echo "环境安装完成！"
echo "请运行: conda activate liednet"
```

使用方法：
```bash
chmod +x setup_new_machine.sh
./setup_new_machine.sh
```

---

## 文件清单

在新电脑上需要以下文件：

1. **必需文件**：
   - `environment.yml` - conda 环境配置
   - `requirements.txt` - pip 依赖列表
   - `kernels/selective_scan/` - CUDA 扩展源码

2. **项目文件**：
   - 整个 `LIEDNet/` 目录

3. **配置文件**：
   - `options/train_LOLv1.yaml` - 训练配置（需要修改数据集路径）

---

## 总结

在新电脑上激活环境的完整流程：

```bash
# 1. 创建环境
conda env create -f environment.yml
# 或
conda create -n liednet python=3.10.19 && conda activate liednet && pip install -r requirements.txt

# 2. 激活环境
conda activate liednet

# 3. 编译 CUDA 扩展
cd kernels/selective_scan && pip install -e . && cd ../..

# 4. 验证
python -c "import torch; print(torch.__version__)"

# 5. 开始训练
python train_llie.py --opt ./options/train_LOLv1.yaml
```







